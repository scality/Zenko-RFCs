
# ZIP#1 (Zenko Improvement Proposal #1 - Workflow Engine

## Overview

### Problem Description

### Use-cases Description

What uses-cases does this address? what impact on actors does this change have ?

Ensure you are clear about the actors in each use case: developers, users, deployers, etc

### Proposed Changes

Here is how we propose to solve the problem.

Scope of the effort.


#### Architecture Diagram

```

+-----------------+
|                 |
|                 |
|                 | Graphical Workflow Edition
|   Orbit UI      |
|                 | Statistics, Dashboard
+---------------+-+
                |
                |
                |              +-------------------------+
                |              |                         |
          JSON workflow        |                         |
                |              |   Workflow Engine       |
                |              |                         |
             +--v--------+     |                         |
             |Management +----->                         |
             |Agent      |     +-^----------------^------+
             +-----------+       |                |
                                 |                |
                                 |                |
                                 |                |
                  +------------+-+                |
                  |            |             +----+------+
                  |            |             |           |
                  | plugin1    |             |           |
                  |            |             | plugin2   |
                  +------------+             |           |
                                             +-----------+

```

#### Components

| Component | Description |
| ------------- | ------------- |
| Graphical workflow edition  | This component is done in Orbit UI. It is possible to define multiple workflows. When saving the workflows, it generates a JSON file that describe the set of workflows that can be read by the Workflow Manager. |
| Workflow Engine  | This component is implemented in Backbeat and executes the actual JSON defined workflows  |
| Plugins | Plugins register to the workflow engine and perform single tasks in the workflow, e.g. compression, trigger lambda. |
| Workflow Statistics | The workflow manager maintains and reports statistics about objects traversing each single workflow and each single step of each workflow. |
| Workflow Dashboard | At any time the system administrator can view graphically the statistics on Orbit UI. |
| Management Agent | Agent that communicates with with Orbit |

### Requirements


#### Execution of the workflow
Orbit sends the new JSON file to the Workflow Manager which will be responsible for executing it. 
Every step will try to match an object name or some properties and possibly trigger an action which can be a built-in function or an external module (e.g. encryption, compression, data movement, etc).

#### Multiple parallel workflows
The Workflow Manager can actually executes many workflows

####  A workflow has many steps
A workflow is composed of many steps, having one or many inputs.

#### Source of a workflow
At every beginning of a workflow there is an MD source (events generated by actual traffic or by a cloud trace (e.g. Admin API or other cloud specific event logs like AWS Lambda or Azure functions). The input of a workflow can also be the result of MD searches executing at specific times (e.g. searchObject(“bar”, “*.jpg” ) bound to a crontab). 

#### Terminator of a workflow
At every end of a workflow there is a terminator that stops the workflow. The terminator can be e.g. a copy on a cloud  - putObjectToLocation(), or a trigger of a Lambda function - executeLambda().

#### Tolerance of impedance between plugins
Since all plugins don’t process information at the same time, and for failure resilience, every time a workflow step needs to execute a specific plugin we perform input AND output queuing (e.g. in a specific topic), the output being the input of the next plugin and so on.

#### Multi-language support
A Workflow module could be written in any language (nodejs, python, go, C, C++, etc) so we will favor a REST API for interacting between modules.

#### Unity of language for the framework itself
The workflow manager is a Backbeat task written in NodeJS.

#### Type of workflows
Workflow management could occur at different steps of Cloudserver:
Authorization step
Notification step (event)
Cron based, e.g. search

#### Nature of queues
Workflows queues only contain some metadata: the object name the object ID and the “location” where to find the object (if possible in a transient source).

#### Type of plugins
Some plugins are MD only (intput/output), some are DATA+MD (input/output), some are hybrid MD input/DATA+MD output, or DATA+MD input/MD output

#### Data manipulation in plugins
Plugins that manipulate data read the data from Cloudserver with the location:objectID specified in queues metadata. The output (if any) of the plugin is streamed to an object in CloudServer and the new location:objectID is stored in the queue for the next plugin in line.

### Alternatives

What are other ways we could implement this, and why are we not using these.

